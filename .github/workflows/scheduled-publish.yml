name: Scheduled News Publishing

on:
  schedule:
    # 매일 오후 2시(한국시간 14:00 = UTC 05:00)에 시작
    - cron: '0 5 * * *'
  
  # 수동 실행도 가능하도록
  workflow_dispatch:

jobs:
  publish-news:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Publish All News with Random Intervals
        run: |
          echo "🚀 Starting scheduled news publishing..."
          echo "📅 Publishing 10 articles with 30-90 minute random intervals"
          VERCEL_URL="https://www.economynews.app"
          
          # 10개 기사를 순차적으로 발행
          for i in {1..10}; do
            echo ""
            echo "========================================="
            echo "📰 Publishing article $i/10..."
            echo "========================================="
            
            response=$(curl -s -w "\n%{http_code}" -X POST \
              "$VERCEL_URL/api/publish" \
              -H "Content-Type: application/json")
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | head -n-1)
            
            echo "Response: $body"
            echo "HTTP Status: $http_code"
            
            if [ "$http_code" -eq 200 ]; then
              echo "✅ Article $i published successfully"
            else
              echo "❌ Failed to publish article $i"
              # 실패해도 계속 진행
            fi
            
            # 마지막 기사가 아니면 30~90분 대기 (초 단위)
            if [ $i -lt 10 ]; then
              # 30~90분 사이 랜덤 (1800~5400초)
              wait_seconds=$((RANDOM % 3601 + 1800))
              wait_minutes=$((wait_seconds / 60))
              
              echo ""
              echo "⏰ Waiting $wait_minutes minutes before next article..."
              echo "   ($(date '+%Y-%m-%d %H:%M:%S'))"
              
              sleep $wait_seconds
            fi
          done
          
          echo ""
          echo "========================================="
          echo "🎉 All articles published!"
          echo "========================================="
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "⚠️ Scheduled publishing failed!"
          # 여기에 Slack/Discord 알림 추가 가능
